var vt=Object.defineProperty,mt=Object.defineProperties;var gt=Object.getOwnPropertyDescriptors;var xe=Object.getOwnPropertySymbols;var bt=Object.prototype.hasOwnProperty,wt=Object.prototype.propertyIsEnumerable;var me=(e,t,n)=>t in e?vt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,oe=(e,t)=>{for(var n in t||(t={}))bt.call(t,n)&&me(e,n,t[n]);if(xe)for(var n of xe(t))wt.call(t,n)&&me(e,n,t[n]);return e},ie=(e,t)=>mt(e,gt(t));var D=(e,t,n)=>(me(e,typeof t!="symbol"?t+"":t,n),n);import{d as L,r as J,o as Ce,a as _t,c as ge,w as Z,b as Te,e as y,f as be,s as re,g as U,h as m,i as $t,j as v,n as w,k as C,l as r,m as _,p as G,q as St,t as kt,u as we,v as S,x as V,y as xt,z as Ct,A as $,B as M,F as Me,C as k,D as I,E as z,G as ze,H as Le,I as Tt,J as A,K as de,L as Mt,M as Ie,N as Re,O as ce,P as H,Q as F,R as Ee,S as zt,T as Lt,U as It,V as ue,W as Rt,X as Et,Y as Pt}from"./vendor.bc67dd30.js";const Dt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))l(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&l(s)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerpolicy&&(o.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?o.credentials="include":a.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function l(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}};Dt();var R=(e,t)=>{for(const[n,l]of t)e[n]=l;return e};const Ht=L({props:{tag:{type:String,default:"div"}},emits:["resize"],setup(e,t){const n=J(null);return Ce(()=>{const l=new ResizeObserver(a=>{t.emit("resize",{width:a[0].contentRect.width,height:a[0].contentRect.height})});l.observe(n.value),_t(()=>{l.unobserve(n.value)})}),{rootEl:n}}});function Ft(e,t,n,l,a,o){return y(),ge(Te(e.tag),{ref:"rootEl","data-role":"resize-observer"},{default:Z(()=>[be(e.$slots,"default")]),_:3},512)}var Pe=R(Ht,[["render",Ft]]);const Bt="_scrollable_66dfd_2",Ot="_track_66dfd_8",Vt="_y_66dfd_11",At="_x_66dfd_12",Wt="_thumb_66dfd_15";var Nt={scrollable:Bt,track:Ot,y:Vt,x:At,thumb:Wt};const jt=40,De=15,Yt=100,He=(e,t)=>Math.max(1,Math.pow(e*(3/1e3)*t,2))*Math.sign(e);function Fe(e,t,n,l,a){var u;if(n<=t)return null;const o=Math.max(0,t-((u=l==null?void 0:l.fixedSize)!=null?u:0)),s=Math.max(jt,Math.floor(t*o/n)),i=(o-s)/(n-t),c=Math.round(a*i);return{trackSize:o,thumbSize:s,fixedSize:e,thumbRatio:i,thumbPos:c}}function Ut(e){let t=0,n=0,l=0,a=0,o=null,s=0,i=0;function c(h){h.button===1&&(h.preventDefault(),h.stopPropagation(),document.body.style.cursor="all-scroll",o=null,t=h.clientY,n=h.clientX,l=0,a=0,s=0,i=requestAnimationFrame(d),document.addEventListener("mousemove",f),document.addEventListener("mouseup",u),document.addEventListener("mouseleave",u))}function u(){cancelAnimationFrame(i),document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",u),document.removeEventListener("mouseleave",u),document.body.style.removeProperty("cursor")}function f(h){const g=h.clientY-t,p=h.clientX-n;if(o===null)if(Math.abs(g)>De)o="vertical",document.body.style.cursor="ns-resize";else if(Math.abs(p)>De)o="horizontal",document.body.style.cursor="ew-resize";else return;o==="vertical"?l=g:a=p}function d(h){const g=h-(s||h);s=h,i=requestAnimationFrame(d),e(He(a,g),He(l,g))}return{handleMousedown:c}}function Gt(e){function t(n){e(0,Math.sign(n.deltaY)*Yt)}return{handleMousewheel:t}}function Be(e,t,n){let l=0,a=0;const o=t==="y"?"y":"x",s=t==="y"?"clientY":"clientX";function i(f){f.preventDefault(),f.stopPropagation();const d=f.currentTarget;if(l=d.getBoundingClientRect()[o],f.target!==d){const h=f.target;a=f[s]-h.getBoundingClientRect()[o]}else a=e.value.thumbSize/2,c(f),a=f[s]-l-e.value.thumbPos;document.addEventListener("mousemove",c),document.addEventListener("mouseup",u),document.addEventListener("mouseleave",u)}function c(f){const d=(f[s]-l-a)/e.value.thumbRatio;t==="x"?n(d,void 0):n(void 0,d)}function u(){document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",u),document.removeEventListener("mouseleave",u)}return{handleTrackMousedown:i}}const qt=L({props:{paintSize:{type:Object,required:!0},fullSize:{type:Object,required:!0},widthY:{type:Number,default:14},widthX:{type:Number,default:12}},emits:["scroll"],setup(e,t){const n=re({y:0,x:0});U(()=>[e.paintSize,e.fullSize],()=>{const{paintSize:i,fullSize:c}=e;n.x=Math.max(0,Math.min(n.x,c.width-i.width)),n.y=Math.max(0,Math.min(n.y,c.height-i.height))},{deep:!0}),U(n,()=>{t.emit("scroll",{y:n.y,x:n.x})});const l=m(()=>Fe(e.widthY,e.paintSize.height,e.fullSize.height,null,n.y)),a=m(()=>Fe(e.widthX,e.paintSize.width,e.fullSize.width,l.value,n.x));function o(i,c){const{paintSize:u,fullSize:f}=e;n.y=Math.max(0,Math.min(n.y+Math.floor(c),f.height-u.height)),n.x=Math.max(0,Math.min(n.x+Math.floor(i),f.width-u.width))}function s(i,c){const{paintSize:u,fullSize:f}=e;i!==void 0&&(n.x=Math.max(0,Math.min(Math.floor(i),f.width-u.width))),c!==void 0&&(n.y=Math.max(0,Math.min(Math.floor(c),f.height-u.height)))}return{scrollbarY:l,scrollbarX:a,scrollPos:$t(n),scrollTo:s,scrollByDelta:o,handleMousedown:Ut(o).handleMousedown,handleMousewheel:Gt(o).handleMousewheel,handleTrackMousedownY:Be(l,"y",s).handleTrackMousedown,handleTrackMousedownX:Be(a,"x",s).handleTrackMousedown}}});function Xt(e,t,n,l,a,o){return y(),v("div",{class:w(e.$style.scrollable),style:C({width:e.paintSize.width+"px",height:e.paintSize.height+"px"}),onMousedown:t[2]||(t[2]=(...s)=>e.handleMousedown&&e.handleMousedown(...s)),onWheel:t[3]||(t[3]=(...s)=>e.handleMousewheel&&e.handleMousewheel(...s))},[be(e.$slots,"default"),e.scrollbarY?(y(),v("div",{key:0,class:w(`${e.$style.track} ${e.$style.y}`),onMousedown:t[0]||(t[0]=(...s)=>e.handleTrackMousedownY&&e.handleTrackMousedownY(...s)),style:C({width:e.scrollbarY.fixedSize+"px",height:e.scrollbarY.trackSize+"px"})},[r("div",{class:w(e.$style.thumb),style:C({transform:`translate(0, ${e.scrollbarY.thumbPos}px)`,width:e.scrollbarY.fixedSize+"px",height:e.scrollbarY.thumbSize+"px"})},null,6)],38)):_("",!0),e.scrollbarX?(y(),v("div",{key:1,class:w(`${e.$style.track} ${e.$style.x}`),onMousedown:t[1]||(t[1]=(...s)=>e.handleTrackMousedownX&&e.handleTrackMousedownX(...s)),style:C({width:e.scrollbarX.trackSize+"px",height:e.scrollbarX.fixedSize+"px"})},[r("div",{class:w(e.$style.thumb),style:C({transform:`translate(${e.scrollbarX.thumbPos}px, 0)`,width:e.scrollbarX.thumbSize+"px",height:e.scrollbarX.fixedSize+"px"})},null,6)],38)):_("",!0)],38)}const Oe={};Oe.$style=Nt;var Ve=R(qt,[["render",Xt],["__cssModules",Oe]]);function Kt(e,t){for(let n=e.offset;n<e.offset+e.length;++n)t[n]=!0}function Ae(e,t,n,l){const a=Math.min(t,n),o=Math.max(t,n);l=l.filter(s=>s.type.byteView&&!s.type.byteView.array);for(let s=a;s<=o;++s)l.some(i=>s>=i.offset&&s<i.offset+i.length)&&(e[s]=!e[s])}function We(e){e.fill(!1)}function Ne(e){const t=[];let n=e.indexOf(!0),l;if(n<0)return t;for(l=n,t.push([l]),n+=1;n<e.length;++n)if(e[n]){const a=n;a-l==1?t[t.length-1].push(a):t.push([a]),l=a}return t}const q=()=>({byteView:{array:!1}});function Jt(e,t){for(let n=0;n<t.length;){const l=t[n];l.name!=null&&e.some(a=>a>=l.offset&&a<l.offset+l.length)?Ye(l,t):n+=1}}function je(e,t){const n=Ne(e);if(n.length===0)throw new Error("No bytes selected");if(n.length>1)throw new Error("Cannot create header from non-contiguous selection");const l=n[0];Jt(l,t);const a=t.find(i=>l[0]>=i.offset&&l[0]+l.length<=i.offset+i.length);let o=[{name:null,offset:a.offset,length:l[0]-a.offset,type:q()},{name:"",offset:l[0],length:l.length,type:q(),textLength:4*3-1},{name:null,offset:l[0]+l.length,length:a.length-(l[0]-a.offset+l.length),type:q()}];const s=o[1];return o=o.filter(i=>i.length),t.splice(t.indexOf(a),1,...o),s}function Ye(e,t){if(e.name==null)throw new Error("Cannot remove empty header");e.name=null,e.type=q();for(let n=0;n<t.length-1;){const l=Zt(t[n],t[n+1]);l?t.splice(n,2,l):n+=1}}function Zt(e,t){return e.name===null&&t.name===null?{name:null,offset:e.offset,length:e.length+t.length,type:q()}:null}function Ue(e,t,n){const l=[];let a=0;for(const o of e){if(o.name==null||o.length)return null;const s=G.getHeaderLength(o,n),i=ie(oe({},o),{length:s,offset:a});if(St.validateHeader(i,t))l.push(i),a+=s;else return null}return{headers:l,increasedRowLength:a<n.rowLength}}function Qt(){return new Worker("/poe-dat-viewer/assets/script.aed4df77.js",{type:"module"})}const fe=kt(new Qt);async function Ge(e){return await fe.decompressSliceInBundle(we(e,[e]))}async function qe(e,t,n){return await fe.decompressSliceInBundle(we(e,[e]),t,n)}async function _e(e,t){return await fe.analyzeDatFile(we(e,(t==null?void 0:t.transfer)?[e.dataFixed.buffer]:[]))}async function en(e,t,n){return await fe.getBatchFileInfo(e,t,n)}const Xe=new Map;function tn(e,t,n){var o;const l=(o=Xe.get(e))==null?void 0:o.deref();if(l)return l;const a=S(null);return nn(e,t,n).then(s=>{s&&(a.value=s)}).catch(()=>{}),Xe.set(e,new WeakRef(a)),a}async function nn(e,t,n){const l=await t.loadFileContent(e),a=G.readDatFile(e,l),o=await _e(a),s=await n.findByName(Je(e)),i=Ue(s,o,a);if(i)return{headers:i.headers,datFile:a}}function sn(e,t,n,l,a){const o=G.readDatFile(e,t),s={headers:S(o.rowLength?[{name:null,offset:0,length:o.rowLength,type:q()}]:[]),datFile:o,name:Je(e),path:e,columnStats:S([]),columnSelection:S(new Array(o.rowLength).fill(!1)),editHeader:S(null),selectedRow:S(null),rowSorting:S(null),scrollPos:re({x:0,y:0}),referencedTables:a.run(()=>m(()=>{var c;const i=new Map;i.set(s.name,S({headers:s.headers.value,datFile:s.datFile}));for(const u of s.headers.value){if(!((c=u.type.key)==null?void 0:c.table)||i.has(u.type.key.table))continue;const f=s.path.replace(`/${s.name}.`,`/${u.type.key.table}.`);i.set(u.type.key.table,tn(f,n,l))}return i}))};return _e(s.datFile).then(async i=>{s.columnStats.value=i,await Ke(s,l)}),s}async function Ke(e,t){e.editHeader.value=null,e.headers.value=e.datFile.rowLength?[{name:null,offset:0,length:e.datFile.rowLength,type:q()}]:[];const n=await t.findByName(e.name);try{ln(n,e)}catch(l){window.alert(`WARN: ${l.message}`)}finally{V(e.headers)}}function ln(e,t){let n=0;for(const l of e){const a=l.length||xt(l,t.datFile);if(l.name==null){n+=a;continue}const o=ie(oe({},l),{length:a,offset:n});if(!(l.length?t.datFile.rowLength-o.offset>=o.length:Ct(o,t.columnStats.value)))throw new Error("The schema is invalid.");Kt(o,t.columnSelection.value);const i=je(t.columnSelection.value,t.headers.value);Object.assign(i,o),We(t.columnSelection.value),n+=a}}function an(e,t){const n=e.filter(({type:l})=>l.boolean||l.decimal||l.integer||l.key||l.string).map((l,a)=>({name:l.name||`Unknown${a+1}`,data:G.readColumn(l,t)}));return n.unshift({name:"_rid",data:Array(t.rowCount).fill(void 0).map((l,a)=>a)}),Array(t.rowCount).fill(void 0).map((l,a)=>Object.fromEntries(n.map(o=>[o.name,o.data[a]])))}function Je(e){return e.match(/[^/]+(?=\..+$)/)[0]}async function he(e,t){await t.saveHeaders(e.name,e.headers.value)}async function on(e,t){await t.removeHeaders(e.name)}const rn=L({props:{args:{type:Object,required:!0}},setup(e){return{text:m(()=>{var a,o,s,i,c,u,f;const{name:t,headers:n}=e.args;let l="";for(const d of n){if(d.name==null)break;let h="";if(d.type.boolean?h="bool":d.type.string?h="string":((a=d.type.integer)==null?void 0:a.size)===1?h=d.type.integer.unsigned?"u8":"i8":((o=d.type.integer)==null?void 0:o.size)===2?h=d.type.integer.unsigned?"u16":"i16":((s=d.type.integer)==null?void 0:s.size)===4?h=d.type.integer.unsigned?"u32":"i32":((i=d.type.integer)==null?void 0:i.size)===8?h=d.type.integer.unsigned?"u64":"i64":((c=d.type.decimal)==null?void 0:c.size)===4?h="f32":((u=d.type.decimal)==null?void 0:u.size)===8?h="f64":d.type.key&&(h=d.type.key.foreign?(f=d.type.key.table)!=null?f:"rid":t),d.type.array)l+=`  ${d.name||"_"}: [${h||"_"}]
`;else if(h)l+=`  ${d.name||"_"}: ${h}
`;else break}return`type ${t} {
${l}}
`})}}}),dn={class:"p-4 overflow-auto border-l flex-1 text-base"};function cn(e,t,n,l,a,o){return y(),v("div",dn,[r("pre",null,$(e.text),1)])}var un=R(rn,[["render",cn]]);const fn="_bar_5acw6_2";var hn={bar:fn};const pn=L({setup(){const e=M("viewer"),t=M("dat-schemas"),n=m(()=>Ne(e.columnSelection.value).map(i=>i.map(c=>String(c)).join(" ")));function l(){const{editHeader:i,columnSelection:c,headers:u}=e;i.value=je(c.value,u.value),We(c.value),V(u),V(c),he(e,t)}function a(){const i=an(e.headers.value,e.datFile);Me.saveAs(new File([JSON.stringify(i,null,2)],`${e.name}.json`,{type:"application/json;charset=utf-8"}))}function o(){le({id:"poe-dat-viewer@show-schema",title:"Schema",type:un,args:{name:e.name,headers:JSON.parse(JSON.stringify(e.headers.value))}})}async function s(){await on(e,t),await Ke(e,t)}return{rowSorting:e.rowSorting,selections:n,defineColumn:l,exportDataJson:a,showSchema:o,restoreSchema:s}}}),yn={class:"flex"},vn={key:0,class:"text-gray-400 italic px-1.5 self-center"},mn=r("i",{class:"codicon codicon-add"},null,-1),gn=z(" Define column"),bn=[mn,gn],wn=r("div",{class:"text-gray-300 px-1.5 mr-1 self-center"},"Selections",-1),_n=["textContent"],$n={class:"flex gap-x-1"},Sn=r("i",{class:"codicon codicon-discard"},null,-1),kn=z(" Restore schema"),xn=[Sn,kn],Cn=r("i",{class:"codicon codicon-json"},null,-1),Tn=z(" Show schema"),Mn=[Cn,Tn],zn=r("i",{class:"codicon codicon-database"},null,-1),Ln=z(" Export data"),In=[zn,Ln];function Rn(e,t,n,l,a,o){return y(),v("div",{class:w(e.$style.bar)},[r("div",yn,[e.selections.length===0?(y(),v("div",vn,"No bytes selected")):e.selections.length===1?(y(),v("button",{key:1,class:"hover:bg-gray-300 hover:text-black px-1.5 flex gap-x-1 items-center",onClick:t[0]||(t[0]=(...s)=>e.defineColumn&&e.defineColumn(...s))},bn)):e.selections.length>1?(y(),v(k,{key:2},[wn,(y(!0),v(k,null,I(e.selections,s=>(y(),v("div",{class:"px-1.5 mr-1 font-mono bg-gray-200 text-black flex items-center",textContent:$(s)},null,8,_n))),256))],64)):_("",!0)]),r("div",$n,[e.rowSorting?(y(),v("button",{key:0,class:"bg-gray-600 hover:bg-gray-300 hover:text-black px-1.5 border border-gray-500",onClick:t[1]||(t[1]=s=>e.rowSorting=null)},"Clear sorting")):_("",!0),r("button",{class:"hover:bg-gray-300 hover:text-black px-1.5 flex gap-x-1 items-center",onClick:t[2]||(t[2]=(...s)=>e.restoreSchema&&e.restoreSchema(...s))},xn),r("button",{class:"hover:bg-gray-300 hover:text-black px-1.5 flex gap-x-1 items-center",onClick:t[3]||(t[3]=(...s)=>e.showSchema&&e.showSchema(...s))},Mn),r("button",{class:"hover:bg-gray-300 hover:text-black px-1.5 flex gap-x-1 items-center",onClick:t[4]||(t[4]=(...s)=>e.exportDataJson&&e.exportDataJson(...s))},In)])],2)}const Ze={};Ze.$style=hn;var En=R(pn,[["render",Rn],["__cssModules",Ze]]);function Pn(e,t,n){const l=G.readColumn(e,n),a=Array.from({length:n.rowCount},(o,s)=>s);return e.type.array?a.sort((o,s)=>{const i=l[o];return(l[s].length-i.length)*t}):e.type.boolean?a.sort((o,s)=>{const i=Number(l[o]),c=Number(l[s]);return(i-c)*t}):e.type.string?a.sort((o,s)=>{const i=l[o],c=l[s];return i.localeCompare(c)*t}):e.type.integer||e.type.decimal?a.sort((o,s)=>{const i=l[o];return(l[s]-i)*t}):e.type.key&&(e.type.key.foreign?a.sort((o,s)=>{const i=l[o];return((l[s]||0)-(i||0))*t}):a.sort((o,s)=>{const i=Number(l[o]);return(Number(l[s])-i)*t})),a}function Dn(e,t){t.text=String(e),t.color="#098658"}function Hn(e,t){t.text=`[${e.join(", ")}]`,t.color="#098658"}function Fn(e,t){t.text=String(e),t.color="#0000ff"}function Bn(e,t){t.text=`[${e.join(", ")}]`,t.color="#0000ff"}function On(e,t){e===""?(t.text="empty",t.color="#0000ff"):(t.text=String(e),t.color="#001080")}function Vn(e,t){t.text=`[${e.map(n=>JSON.stringify(n)).join(", ")}]`,t.color="#001080"}function Qe(e,t){e===null?(t.text="<null, self>",t.color="#0000ff"):(t.text=`<${e}, self>`,t.color="#098658")}function An(e,t){t.text=`[${e.map(n=>`<${n}, self>`).join(", ")}]`,t.color="#098658"}function et(e,t){e===null?(t.text="<null>",t.color="#0000ff"):(t.text=`<${e}>`,t.color="#098658")}function Wn(e,t){t.text=`[${e.map(n=>`<${n}>`).join(", ")}]`,t.color="#098658"}function tt(e,t,n,l,a){const o=ze.getFieldReader(t,n);if(a==null?void 0:a.header.type.array)throw new Error("Can't show array of arrays.");const s=a&&ze.getFieldReader(a.header,a.datFile),i={text:"",color:""},c=(()=>{var h,g;const d=a!=null?a.header.type:t.type;if(t.type.array){if(d.boolean)return Bn;if(d.string)return Vn;if(d.integer||d.decimal)return Hn;if((h=d.key)==null?void 0:h.foreign)return Wn;if(d.key)return An}else{if(d.boolean)return Fn;if(d.string)return On;if(d.integer||d.decimal)return Dn;if((g=d.key)==null?void 0:g.foreign)return et;if(d.key)return Qe}throw new Error("never")})();let u=0,f="";for(const d of l){let h=o(d);a?t.type.array?(h=h.map(g=>s(g)),c(h,i)):h===null?(t.type.key.foreign?et:Qe)(h,i):(h=s(h),c(h,i)):c(h,i),f!==i.color&&(e.fillStyle=i.color,f=i.color),e.fillText(i.text,0,u),u+=E}}function Nn(e,t,n,l,a,o){e.fillStyle="#000";let s=0;for(const i of l){const c=n.dataFixed.subarray(i*n.rowLength+t.offset+a,i*n.rowLength+t.offset+o),u=Array.from(c,f=>f.toString(16).padStart(2,"0")).join(" ");e.fillText(u,a*(B*3),s),s+=E}}function jn(e,t,n,l,a){e.fillStyle="#000";const o=a.refArray,s=Math.max(o.keyForeign?n.fieldSize.KEY_FOREIGN:0,o.keySelf?n.fieldSize.KEY:0,o.string?n.fieldSize.STRING:0,o.numeric32?n.fieldSize.LONG:0,n.fieldSize.BYTE),i=Math.ceil(t.textLength/3);let c=0;for(const u of l){const f=n.readerFixed.getSizeT(u*n.rowLength+t.offset);if(f===0)e.fillText("[]",0,c);else{const d=n.readerFixed.getSizeT(u*n.rowLength+t.offset+n.memsize),h=n.dataVariable.subarray(d,d+Math.min(s*f,i)),g=Array.from(h,p=>p.toString(16).padStart(2,"0")).join(" ");e.fillText(`${f} { ${g} }`,0,c)}c+=E}}const X='Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',j=14,B=Kn(j,X),Yn=Jn(j,X),E=19,Un=3,K=1,Gn=7,ne=Math.round(B*3),Q=ne*2+Gn*3;function qn(e){const t=String(e-1).length;return Math.max(t,Un)}function nt(e){return Math.ceil(qn(e)*B)}function Xn(e){return nt(e)+8*2}function Kn(e,t){const l=document.createElement("canvas").getContext("2d");return l.font=`${e}px ${t}`,l.measureText("0").width}function Jn(e,t){const l=document.createElement("canvas").getContext("2d");l.font=`${e}px ${t}`,l.textBaseline="middle";const a=l.measureText("0");return e/2+(a.alphabeticBaseline!==void 0?-a.alphabeticBaseline:a.actualBoundingBoxDescent)}function Zn(e){return 1+(e-j)/2+Yn}function Qn(e){const{ctx:t}=e;if(t.fillStyle="#fff",t.fillRect(0,0,t.canvas.width,t.canvas.height),e.viewer.selectedRow.value!==null){const l=e.rows.indexOf(e.viewer.selectedRow.value);l!==-1&&(t.fillStyle="#bee3f8",t.fillRect(0,e.top+l*E,t.canvas.width,E))}t.save(),t.translate(-e.left,0),es(t,e.columns),t.restore(),t.font=`${j}px ${X}`,t.fillStyle="#000";const n=ts(e.viewer,e.left,e.left+e.paintWidth);for(const l of n)t.save(),t.beginPath(),t.translate(l.left-e.left,0),t.rect(0,0,l.width,t.canvas.height),t.clip(),t.translate(B/2,e.top+Zn(E)),l.exec(t,e.rows),t.restore();{const l=t.createLinearGradient(0,-16,0,4);l.addColorStop(0,"rgba(254,254,254,0.6)"),l.addColorStop(1,"transparent"),t.fillStyle=l,t.fillRect(0,0,t.canvas.width,6);const a=t.createLinearGradient(-16,0,4,0);a.addColorStop(0,"rgba(254,254,254,0.5)"),a.addColorStop(1,"transparent"),t.fillStyle=a,t.fillRect(0,0,6,t.canvas.height)}}function es(e,t){for(const n of t)n.selected&&(e.fillStyle="#bee3f8",e.fillRect(n.leftPx+(n.border?K:0),0,n.widthPx,e.canvas.height)),n.border&&(e.fillStyle="#bdbdbd",e.fillRect(n.leftPx,0,K,e.canvas.height))}function ts(e,t,n){const l=e.headers.value,a=e.columnStats.value,o=e.datFile,s=[];let i=0;for(const c of l){const u=pe(c);if(i+u.borderWidth>=t)if(c.type.byteView)if(c.type.byteView.array)s.push({left:i+(u.borderWidth?K:0),width:u.paddingWidth,exec:(f,d)=>jn(f,c,o,d,a[c.offset])});else{const f=Math.max(0,Math.floor((t-i)/(B*3))),d=Math.min(c.length,Math.ceil((n-i)/(B*3)));s.push({left:i+(u.borderWidth?K:0),width:u.paddingWidth,exec:(h,g)=>Nn(h,c,o,g,f,d)})}else s.push({left:i+(u.borderWidth?K:0),width:u.paddingWidth,exec:(f,d)=>{var h;if(((h=c.type.key)==null?void 0:h.table)&&c.type.key.viewColumn){const g=e.referencedTables.value.get(c.type.key.table).value;if(g){const p=g.headers.find(b=>b.name===c.type.key.viewColumn);if(p)return tt(f,c,o,d,{header:p,datFile:g.datFile})}}return tt(f,c,o,d)}});if(i+=u.borderWidth,i>=n)return s}return s}function pe(e){const t=e.type.byteView&&!e.type.byteView.array?e.length*3-1:e.textLength;return{paddingWidth:Math.ceil((t+1)*B),borderWidth:Math.ceil((t+1)*B)+(e.offset>0?K:0),hasBorder:e.offset>0}}function ns(e){let t=0;for(const n of e)t+=pe(n).borderWidth;return t}function st(e,t,n,l){const a=[];let o=0;for(const s of e){const i=pe(s);if(o+i.borderWidth>=n&&a.push({offset:s.offset,border:i.hasBorder,active:s===t,widthPx:i.borderWidth,leftPx:o,name:s.name}),o+=i.borderWidth,o>=l)return a}return a}const ss=L({props:{left:{type:Number,required:!0},width:{type:Number,required:!0},columns:{type:Array,required:!0}},setup(e){const t=S(0);let n=-1,l=[];const a=M("viewer"),o=M("dat-schemas");function s(d){n=d,l=[...a.columnSelection.value],Ae(a.columnSelection.value,n,n,a.headers.value),V(a.columnSelection),document.addEventListener("mouseup",h),document.addEventListener("mouseleave",h);function h(){n=-1,document.removeEventListener("mouseup",h),document.removeEventListener("mouseleave",h)}}function i(d,h){if(n===-1||h.buttons!==1)return;const{memsize:g}=a.datFile,p=d-n;p>=g?d=n+g*2-1:p>=4?d=n+8-1:p>=2&&(d=n+4-1),p<=-g?d=n-g*2+1:p<=-4?d=n-8+1:p<=-2&&(d=n-4+1),a.columnSelection.value=[...l],Ae(a.columnSelection.value,n,d,a.headers.value)}function c(d){const h=a.headers.value.find(g=>g.offset===d);a.editHeader.value===h&&(!h.type.byteView||h.type.byteView.array)?(t.value===0?t.value=1:t.value===1?t.value=-1:t.value===-1&&(t.value=1),a.rowSorting.value=Pn(h,t.value,a.datFile)):(a.editHeader.value=h,t.value=0)}function u(d,h){h.preventDefault();const g=a.headers.value.find(p=>p.offset===d);g.textLength!=null&&(g.textLength=Math.max(1,g.textLength-Math.sign(h.deltaY)*(h.ctrlKey?4*3-2:1)),V(a.headers),he(a,o))}return{headers:m(()=>st(a.headers.value,a.editHeader.value,e.left,e.left+e.width)),selectStart:s,selectContinue:i,editHeader:c,handleHeaderWheel:u,headersRowStyle:m(()=>({transform:`translate(${-e.left}px, 0)`,lineHeight:ne+"px",fontFamily:X,fontSize:j+"px"})),colsRowStyle:m(()=>({transform:`translate(${-e.left}px, ${ne}px)`,lineHeight:ne+"px",fontFamily:X,fontSize:j+"px"})),statsRowStyle:m(()=>({transform:`translate(${-e.left}px, ${ne*2}px)`,fontFamily:X,fontSize:j+"px"}))}}}),ls={class:"datv-header-layer"},as=["title","onClick","onWheel"],os=z("\xA0"),is={key:1,class:"bg-gray-500 text-gray-200 px-1"},rs=["onMousedown","onMouseenter","title","textContent"],ds={key:0,class:"datv-stat__line bg-yellow-500",style:{top:"0"}},cs={key:1,class:"datv-stat__line bg-green-500",style:{top:"7px"}},us={key:2,class:"datv-stat__line bg-gray-800",style:{top:"14px"}},fs={key:3,class:"datv-stat__line bg-pink-400",style:{top:"14px"}},hs=["textContent"],ps={key:1,class:"inline-flex mx-auto items-center h-full"},ys=r("i",{class:"codicon codicon-key"},null,-1),vs=[ys];function ms(e,t,n,l,a,o){return y(),v("div",ls,[r("div",{style:C(e.headersRowStyle),class:"absolute"},[(y(!0),v(k,null,I(e.headers,s=>(y(),v("button",{key:s.offset,class:w(["datv-header",{"datv-col--border":s.border,"datv-header--active":s.active}]),style:C({width:s.widthPx+"px",transform:`translate(${s.leftPx}px, 0)`}),title:s.name==null?"unidentified":s.name||"unnamed",onClick:i=>e.editHeader(s.offset),onWheel:i=>e.handleHeaderWheel(s.offset,i)},[s.name===null?(y(),v(k,{key:0},[os],64)):s.name===""?(y(),v("span",is,"?")):(y(),v(k,{key:2},[z($(s.name),1)],64))],46,as))),128))],4),r("div",{style:C(e.colsRowStyle),class:"absolute"},[(y(!0),v(k,null,I(e.columns,s=>(y(),v("button",{key:s.offset,class:w(["datv-byte",{"datv-col--border":s.border,"datv-byte--selected":s.selected}]),style:C({width:s.widthPx+"px",transform:`translate(${s.leftPx}px, 0)`}),onMousedown:i=>e.selectStart(s.offset),onMouseenter:i=>e.selectContinue(s.offset,i),title:String(s.offset),textContent:$(s.text)},null,46,rs))),128))],4),r("div",{style:C(e.statsRowStyle),class:"absolute datv-stats_row"},[(y(!0),v(k,null,I(e.columns,s=>(y(),v("div",{key:s.offset,class:w(["datv-stat",{"datv-col--border":s.border,"datv-byte--selected":s.selected}]),style:C({width:s.widthPx+"px",transform:`translate(${s.leftPx}px, 0)`})},[s.stat?(y(),v(k,{key:0},[s.stat.string?(y(),v("div",ds)):_("",!0),s.stat.array?(y(),v("div",cs)):_("",!0),s.stat.zero?(y(),v("div",us)):s.stat.nullable?(y(),v("div",fs)):_("",!0),r("div",{class:"datv-stat__max",textContent:$(s.stat.max)},null,8,hs)],64)):s.key?(y(),v("span",ps,vs)):_("",!0)],6))),128))],4)])}var gs=R(ss,[["render",ms]]);function bs(e,t){let n=0;for(let l=0;l<e.length;l+=1){const a=t.indexOf(e[l]);a!==-1&&(n+=1,l===0&&a===0&&(n+=2),l>0&&a>0&&e[l-1]===t[a-1]&&(n+=1),l<e.length-1&&a<t.length-1&&e[l+1]===t[a+1]&&(n+=1))}return n}const lt=/([A-Z][a-z]+|[A-Z]{2,}(?![a-z]{2,}))/g;function ws(e,t,n){const l=n.filter(u=>t<u.totalRows&&u.name!==e),a=e.match(lt).map(u=>Le.exports.singular(u)),o=l.map((u,f)=>{const d=u.name.match(lt).map(h=>Le.exports.singular(h));return[f,t-u.totalRows,bs(d,a)]}),s=o[0].length,i=new Array(s).fill(1/0),c=new Array(s).fill(-1/0);for(let u=0;u<o.length;u+=1)for(let f=1;f<s;f+=1){const d=o[u][f];d<i[f]&&(i[f]=d),d>c[f]&&(c[f]=d)}for(let u=1;u<s;u+=1)if(i[u]!==c[u])for(let f=0;f<o.length;f+=1)o[f][u]=(o[f][u]-i[u])/(c[u]-i[u]);return o.sort((u,f)=>f.reduce((d,h)=>d+h)-f[0]-(u.reduce((d,h)=>d+h)-u[0])),o.map(([u])=>l[u])}function _s(e,t,n){const l=[],{fieldSize:a}=n,o=e.length;return o===a.ARRAY&&t.refArray&&l.push({label:"Array",value:"array"}),o===a.STRING&&t.refString&&l.push({label:"String",value:"string"}),o===a.KEY&&t.keySelf&&l.push({label:"Key (self)",value:"key_self"}),o===a.KEY_FOREIGN&&t.keyForeign&&l.push({label:"Key (foreign)",value:"key_foreign"}),o===4&&l.push({label:"Integer",value:"integer"}),o===4&&l.push({label:"Decimal",value:"decimal"}),o===1&&t.maxValue<=1&&l.push({label:"Boolean",value:"boolean"}),l}function $s(e,t){const n=[];if(!e.type.array||!t.refArray)return n;const l=t.refArray;return l.string&&n.push({label:"String",value:"string"}),l.keySelf&&n.push({label:"Key (self)",value:"key_self"}),l.keyForeign&&n.push({label:"Key (foreign)",value:"key_foreign"}),l.numeric32&&n.push({label:"Integer - 4 bytes",value:"integer_4"}),l.numeric32&&n.push({label:"Decimal - 4 bytes",value:"decimal_4"}),l.boolean&&n.push({label:"Boolean",value:"boolean"}),n}function Ss(e,t){const n=S([]);return t.findByName(e).then(l=>{n.value=l}).catch(()=>{}),n}const ks=L({setup(){const e=M("viewer"),t=M("dat-schemas"),n=m(()=>e.editHeader.value&&Tt(e.editHeader.value));{let p=null;U(n,b=>{p&&(p(),p=null),b&&(p=U(b,()=>{V(e.headers),he(e,t)},{deep:!0}))})}const l=m(()=>e.columnStats.value[n.value.offset]),a=m({get(){const p=n.value.type;return p.array?"array":p.string?"string":p.key?p.key.foreign?"key_foreign":"key_self":p.integer?"integer":p.decimal?"decimal":p.boolean?"boolean":void 0},set(p){const b=n.value;b.type={},p==="array"?(b.type.array=!0,b.type.byteView={array:!0}):p==="string"?b.type.string={}:p==="key_foreign"?b.type.key={foreign:!0,table:null,viewColumn:null}:p==="key_self"?b.type.key={foreign:!1,table:e.name,viewColumn:null}:p==="integer"?b.type.integer={unsigned:!1,size:b.length}:p==="decimal"?b.type.decimal={size:b.length}:p==="boolean"&&(b.type.boolean={})}}),o=m({get(){const p=n.value.type;return p.string?"string":p.key?p.key.foreign?"key_foreign":"key_self":p.integer?`integer_${p.integer.size}`:p.decimal?`decimal_${p.decimal.size}`:p.boolean?"boolean":void 0},set(p){const b=n.value;b.type={array:!0},p==="string"?b.type.string={}:p==="key_foreign"?b.type.key={foreign:!0,table:null,viewColumn:null}:p==="key_self"?b.type.key={foreign:!1,table:e.name,viewColumn:null}:p==="integer_1"?b.type.integer={unsigned:!1,size:1}:p==="integer_2"?b.type.integer={unsigned:!1,size:2}:p==="integer_4"?b.type.integer={unsigned:!1,size:4}:p==="integer_8"?b.type.integer={unsigned:!1,size:8}:p==="decimal_4"?b.type.decimal={size:4}:p==="decimal_8"?b.type.decimal={size:8}:p==="boolean"&&(b.type.boolean={})}}),s=m(()=>{const p=[],b=n.value.type;return p.push({label:"Bytes",value:"bytes"}),b.array&&p.push({label:"Var. bytes",value:"array-bytes"}),p.push({label:"Data",value:"data",disabled:!a.value||a.value==="array"&&!o.value}),p}),i=m({get(){const p=n.value.type;return p.byteView?p.byteView.array?"array-bytes":"bytes":"data"},set(p){const b=n.value.type;p==="data"?b.byteView=void 0:b.byteView={array:p==="array-bytes"}}}),c=m(()=>{const p=G.readColumn(n.value,e.datFile);return Math.max(...n.value.type.array?p.flat():p)}),u=m(()=>{let p;if(!n.value.type.key.foreign)return p=[{value:e.name,label:e.name}],p;if(p=[{value:null,label:"rid (unknown)"}],t.tableStats.length){const b=ws(e.name,c.value,t.tableStats);p.push(...b.map(T=>({value:T.name,label:T.name})))}else n.value.type.key.table!==null&&p.push({value:n.value.type.key.table,label:n.value.type.key.table});return p}),f=m(()=>{var p;return((p=n.value.type.key)==null?void 0:p.table)?Ss(n.value.type.key.table,t):null}),d=m(()=>{var T,O;if(!n.value.type.key)return[];const p=[{value:null,label:"row index"}],b=n.value.type.key.foreign?(O=(T=f.value)==null?void 0:T.value)!=null?O:[]:e.headers.value;return p.push(...b.filter(W=>W.name!==null&&W.name.length&&!W.type.array).map(W=>({label:W.name,value:W.name}))),p});function h(){e.editHeader.value=null}function g(){Ye(n.value,e.headers.value),e.editHeader.value=null,V(e.headers),he(e,t)}return{isVisible:m(()=>e.editHeader.value!=null),HEADERS_HEIGHT:Q,header:n,byteViewMode:i,dataType:a,arrayType:o,close:h,remove:g,viewModeOpts:s,keyTableOpts:u,keyDisplayColumnOpts:d,dataTypeOpts:m(()=>_s(n.value,l.value,e.datFile)),arrayTypeOpts:m(()=>$s(n.value,l.value))}}}),xs={key:0,style:{width:"300px"},class:"relative overflow-hidden"},Cs={class:"m-2 shadow border border-gray-300 bg-white absolute inset-0 flex flex-col"},Ts={class:"p-2 bg-gray-100 text-gray-600 shadow flex items-center"},Ms=r("span",{class:"px-2"},"Column properties",-1),zs=r("i",{class:"codicon codicon-close"},null,-1),Ls=[zs],Is={key:0,class:"p-4"},Rs={key:1,class:"p-4 overflow-auto"},Es={class:"mb-4"},Ps=r("label",{for:"datv-header-name"},"Name",-1),Ds={class:"mb-4 flex items-baseline"},Hs=r("div",{class:"mr-2"},"View mode",-1),Fs={class:"gap-x-px flex"},Bs=["onClick","disabled","textContent"],Os={class:"mb-4"},Vs={class:"mb-2 flex justify-between items-baseline"},As=r("span",null,"Data type",-1),Ws={class:"inline-flex items-center"},Ns=["value"],js={class:"ml-2 cursor-pointer"},Ys={key:0,class:"mt-3"},Us=r("div",{class:"mb-1"},"of ...",-1),Gs={class:"inline-flex items-center"},qs=["value"],Xs={class:"ml-2 cursor-pointer"},Ks={key:0,class:"mb-4"},Js={class:"inline-flex items-center"},Zs=r("span",{class:"ml-2 cursor-pointer"},"Unsigned",-1),Qs={key:1,class:"mb-4"},el=r("label",{for:"datv-header-key-table"},"Table",-1),tl=["value"],nl=r("hr",{class:"my-6"},null,-1),sl={key:2,class:"mb-4"},ll=r("label",{for:"datv-header-key-column"},"Display Column",-1),al=["value"],ol={key:3,class:"mb-4"},il=r("label",{class:"mr-4"},"Width",-1),rl=z(" chars "),dl=r("div",{class:"italic mt-2"},"(move mouse over the column name in Viewer and use `ScrollWheel`, hold `Ctrl` to increase resize step)",-1);function cl(e,t,n,l,a,o){return e.isVisible?(y(),v("div",xs,[r("div",{style:C({height:e.HEADERS_HEIGHT+"px"}),class:"bg-gray-100"},null,4),r("div",Cs,[r("div",Ts,[Ms,r("button",{class:"border border-gray-400 rounded-full px-3",onClick:t[0]||(t[0]=s=>e.$emit("focus-editing-header"))},"Focus"),r("button",{onClick:t[1]||(t[1]=(...s)=>e.close&&e.close(...s)),class:"px-2 py-1 ml-auto",title:"Close"},Ls)]),e.header.name===null?(y(),v("div",Is,[r("div",null,$(e.header.length)+" bytes of unidentified data",1)])):(y(),v("div",Rs,[r("div",Es,[Ps,A(r("input",{id:"datv-header-name",placeholder:"Unnamed","onUpdate:modelValue":t[2]||(t[2]=s=>e.header.name=s),class:"border p-1 mt-1 w-full focus:border-blue-500",spellcheck:"false"},null,512),[[de,e.header.name,void 0,{trim:!0}]])]),r("div",Ds,[Hs,r("div",Fs,[(y(!0),v(k,null,I(e.viewModeOpts,s=>(y(),v("button",{key:s.value,class:w(["px-2",e.byteViewMode===s.value?"bg-blue-600 text-white":"bg-gray-100 hover:bg-gray-300"]),onClick:i=>e.byteViewMode=s.value,disabled:s.disabled,textContent:$(s.label)},null,10,Bs))),128))])]),r("div",Os,[r("div",Vs,[As,r("button",{class:"text-red-700 bg-red-100 px-2",onClick:t[3]||(t[3]=(...s)=>e.remove&&e.remove(...s))},"Delete")]),r("div",null,[(y(!0),v(k,null,I(e.dataTypeOpts,s=>(y(),v("div",{key:s.value,class:"mb-0.5"},[r("label",Ws,[A(r("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=i=>e.dataType=i),value:s.value},null,8,Ns),[[Re,e.dataType]]),r("span",js,$(s.label),1)])]))),128)),e.arrayTypeOpts.length?(y(),v("div",Ys,[Us,(y(!0),v(k,null,I(e.arrayTypeOpts,s=>(y(),v("div",{key:s.value,class:"mb-0.5"},[r("label",Gs,[A(r("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=i=>e.arrayType=i),value:s.value},null,8,qs),[[Re,e.arrayType]]),r("span",Xs,$(s.label),1)])]))),128))])):_("",!0)])]),e.header.type.integer?(y(),v("div",Ks,[r("label",Js,[A(r("input",{type:"checkbox","onUpdate:modelValue":t[6]||(t[6]=s=>e.header.type.integer.unsigned=s)},null,512),[[Mt,e.header.type.integer.unsigned]]),Zs])])):_("",!0),e.header.type.key?(y(),v("div",Qs,[el,A(r("select",{id:"datv-header-key-table",class:"border mt-1 w-full focus:border-blue-500","onUpdate:modelValue":t[7]||(t[7]=s=>e.header.type.key.table=s)},[(y(!0),v(k,null,I(e.keyTableOpts,s=>(y(),v("option",{key:s.label,value:s.value},$(s.label),9,tl))),128))],512),[[Ie,e.header.type.key.table]])])):_("",!0),nl,e.keyDisplayColumnOpts.length?(y(),v("div",sl,[ll,A(r("select",{id:"datv-header-key-column",class:"border mt-1 w-full focus:border-blue-500","onUpdate:modelValue":t[8]||(t[8]=s=>e.header.type.key.viewColumn=s)},[(y(!0),v(k,null,I(e.keyDisplayColumnOpts,s=>(y(),v("option",{key:s.label,value:s.value},$(s.label),9,al))),128))],512),[[Ie,e.header.type.key.viewColumn]])])):_("",!0),e.dataType?(y(),v("div",ol,[il,A(r("input",{"onUpdate:modelValue":t[9]||(t[9]=s=>e.header.textLength=s),class:"border w-16 text-center"},null,512),[[de,e.header.textLength,void 0,{number:!0}]]),rl,dl])):_("",!0)]))])])):_("",!0)}var ul=R(ks,[["render",cl]]);const fl=Math.ceil(B*3);function hl(e,t,n,l,a){const o=[];let s=0;for(const i of n){const c=pe(i);if(i.type.byteView&&!i.type.byteView.array){let u=s;for(let f=0;f<i.length;++f){const d=c.hasBorder&&f===0,h=B*3+(d?K:0);if(Math.ceil(u)+h<l){u+=h;continue}const g=i.offset+f;if(o.push({offset:g,selected:e[g],border:d,widthPx:fl,leftPx:Math.ceil(u),text:String(g%100).padStart(2,"0"),stat:t[g],key:!1}),u+=h,Math.ceil(u)>=a)return o}}else s+c.borderWidth>=l&&o.push({offset:i.offset,selected:!1,border:c.hasBorder,widthPx:c.paddingWidth,leftPx:s,text:String(i.offset%100).padStart(2,"0"),key:i.type.key!=null});if(s+=c.borderWidth,s>=a)return o}return o}function pl(e,t){const n=e.map(a=>({max:a.maxValue.toString(16).padStart(2,"0"),array:!1,string:!1,nullable:!1,zero:a.maxValue===0})),{fieldSize:l}=t;for(let a=0;a<e.length;++a){const o=e[a];if(o.refString)for(let s=0;s<l.STRING;++s)n[a+s].string=!0;if(o.refArray)for(let s=0;s<l.ARRAY;++s)n[a+s].array=!0;if(o.nullableMemsize)for(let s=0;s<t.memsize;++s)n[a+s].nullable=!0}return n}const yl="_rowsOverlay_wksgp_2";var vl={rowsOverlay:yl};const ml=L({components:{ResizeObserver:Pe,CanvasScroll:Ve,ViewerActions:En,ViewerHead:gs,HeaderProps:ul},emits:["update:kaState"],props:{args:{type:Object,required:!0},kaState:{type:Object,default:void 0},kaScope:{type:Object,required:!0}},setup(e,t){const n=M("bundle-index"),l=M("dat-schemas");let a;e.kaState?a=e.kaState:(a=sn(e.args.fullPath,e.args.fileContent,n,l,e.kaScope),t.emit("update:kaState",a)),ce("viewer",a);const o=J(null),s=J(null);Ce(()=>{s.value.scrollTo(a.scrollPos.x,a.scrollPos.y)});const i=m(()=>a.rowSorting.value?a.rowSorting.value:Array.from({length:a.datFile.rowCount},(x,N)=>N)),c=J(0),u=J(0);function f(x){c.value=x.width,u.value=x.height}const{scrollPos:d}=a;function h(x){d.x=x.x,d.y=x.y}const g=m(()=>ns(a.headers.value)),p=m(()=>a.datFile.rowCount*E),b=m(()=>Xn(a.datFile.rowCount)),T=m(()=>Math.max(0,c.value-b.value)),O=m(()=>Math.max(0,u.value-Q));U([T,O],()=>{const x=window.devicePixelRatio;o.value.style.width=T.value+"px",o.value.style.height=O.value+"px",o.value.width=T.value*x,o.value.height=O.value*x,o.value.getContext("2d",{alpha:!1}).scale(x,x),ke()});const W=m(()=>pl(a.columnStats.value,a.datFile)),ye=m(()=>hl(a.columnSelection.value,W.value,a.headers.value,d.x,d.x+Math.min(g.value,T.value))),ht=m(()=>{for(const x of a.referencedTables.value.values())x.value});U([d,ye,i,a.selectedRow,ht],()=>{ke()});function ke(){const x=o.value.getContext("2d",{alpha:!1});Qn({left:d.x,paintWidth:T.value,top:ve.value.top,rows:ve.value.ids,columns:ye.value,viewer:a,ctx:x})}const ve=m(()=>{const x=d.y,N=Math.ceil(O.value/E)+1,Y=Math.floor(x/E);return{top:Y*E-x,ids:i.value.slice(Y,Y+N)}});function pt(){const x=a.editHeader.value,Y=st(a.headers.value,null,0,0+1/0).find(te=>te.offset===x.offset);s.value.scrollTo(Y.leftPx-T.value*.33,void 0)}function yt(x){const{selectedRow:N}=a,Y=Math.floor((x.offsetY+d.y)/E),te=i.value[Y];N.value=N.value!==te?te:null}return{headerBlockStyle:m(()=>({height:Q+"px",width:c.value+"px"})),headerOverlayContentStyle:m(()=>({left:b.value+"px",height:Q+"px",width:T.value+"px"})),scrollableStyle:m(()=>({top:Q+"px",left:b.value+"px"})),scrollablePaintSize:m(()=>({width:T.value,height:O.value})),scrollableFullSize:m(()=>({width:g.value,height:p.value})),rowsOverlayStyle:m(()=>({top:Q+"px",width:b.value+"px",height:O.value+"px",fontFamily:X,fontSize:j+"px",lineHeight:E+"px"})),handleScroll:h,handleResize:f,renderItems:ve,canvasRef:o,renderColumns:ye,scrollLeft:m(()=>d.x),rowsWidth:m(()=>Math.min(g.value,T.value)),LINE_HEIGHT:E,canvasScroll:s,rowsNumberWidth:nt(a.datFile.rowCount)+"px",focusEditingHeader:pt,handleCanvasClick:yt}}}),gl={class:"flex flex-1"},bl=["textContent"];function wl(e,t,n,l,a,o){const s=H("viewer-actions"),i=H("viewer-head"),c=H("canvas-scroll"),u=H("resize-observer"),f=H("header-props");return y(),v(k,null,[F(s),r("div",gl,[F(u,{onResize:e.handleResize,class:"flex-1 min-h-0 relative"},{default:Z(()=>[r("div",{class:"bg-gray-100 absolute",style:C(e.headerBlockStyle)},[F(i,{style:C(e.headerOverlayContentStyle),left:e.scrollLeft,width:e.rowsWidth,columns:e.renderColumns},null,8,["style","left","width","columns"])],4),F(c,{ref:"canvasScroll",class:"absolute bg-white",onScroll:e.handleScroll,style:C(e.scrollableStyle),"paint-size":e.scrollablePaintSize,"full-size":e.scrollableFullSize},{default:Z(()=>[r("canvas",{ref:"canvasRef",onClick:t[0]||(t[0]=(...d)=>e.handleCanvasClick&&e.handleCanvasClick(...d))},null,512)]),_:1},8,["onScroll","style","paint-size","full-size"]),r("div",{class:w(e.$style.rowsOverlay),style:C(e.rowsOverlayStyle)},[r("div",{class:"absolute",style:C({transform:`translate(0, ${e.renderItems.top}px)`})},[(y(!0),v(k,null,I(e.renderItems.ids,(d,h)=>(y(),v("div",{key:d,style:C({transform:`translate(0, ${h*e.LINE_HEIGHT}px)`,width:e.rowsNumberWidth,position:"absolute"}),textContent:$(d)},null,12,bl))),128))],4)],6)]),_:1},8,["onResize"]),F(f,{onFocusEditingHeader:e.focusEditingHeader},null,8,["onFocusEditingHeader"])])],64)}const at={};at.$style=vl;var ot=R(ml,[["render",wl],["__cssModules",at]]);const _l="_input_16vaf_2",$l="_label_16vaf_20",Sl="_importVariant_16vaf_26";var kl={input:_l,label:$l,importVariant:Sl};const xl=L({setup(){const e=M("bundle-index"),t=M("dat-schemas"),n=S(localStorage.getItem("POE_PATCH_VER")||""),l=S("");n.value&&!e.isLoaded&&o(),t.isLoaded||t.fetchSchema(),s();async function a(i){const c=i.target.files[0],u=new Uint8Array(await c.arrayBuffer()),f=c.name;le({id:`file@${f}`,title:f,type:ot,args:{fileContent:u,fullPath:f}})}async function o(){try{await e.loader.setPatch(n.value),await e.loadIndex(),localStorage.setItem("POE_PATCH_VER",n.value)}catch(i){throw window.alert(i.message),i}}async function s(){const c=await(await fetch("https://raw.githubusercontent.com/poe-tool-dev/latest-patch-version/main/latest.txt")).text();l.value=c}return{poePatch:n,latestPoEPatch:l,isCdnImportRunning:m(()=>e.loader.progress.value!=null),isFetchingSchema:m(()=>t.isLoading),handleFile:a,cdnImport:o}}}),Cl={class:"p-4 overflow-auto border-l flex-1 text-base"},Tl={class:"flex gap-x-4 items-baseline mt-4"},Ml=r("div",{class:"max-w-xl mb-4 font-semibold"},"Useful when a new league is released. While the update is still downloading, you can review files and fix schema directly from the update servers.",-1),zl={class:"inline-flex items-baseline pb-2"},Ll={style:{width:"200px"},class:"my-1"},Il={style:{width:"100px"},class:"m-1"},Rl={style:{width:"220px"},class:"my-1"},El=["disabled","loading"],Pl={key:0},Dl=z(" Latest PoE patch is "),Hl={class:"px-1 border border-gray-300 rounded"},Fl={class:"flex gap-x-4 items-baseline mt-4 border-b pb-3"},Bl={class:"flex items-baseline"},Ol=r("span",{class:"pr-2"},"or just",-1),Vl=r("label",{class:"bg-gray-100 py-1 px-2 cursor-pointer hover:bg-gray-300",style:{width:"200px"},for:"import-local-file"},"Pick a local dat file",-1),Al={class:"mt-3 flex gap-x-2 items-center"},Wl={key:0,class:"codicon codicon-loading animate-spin"},Nl={key:1,class:"codicon codicon-check"},jl={key:0},Yl={key:1},Ul=r("a",{href:"https://github.com/poe-tool-dev/dat-schema",class:"underline",target:"_blank"},"github.com/poe-tool-dev/dat-schema",-1);function Gl(e,t,n,l,a,o){return y(),v("div",Cl,[r("div",Tl,[r("div",{class:w(e.$style.importVariant)},"1",2),r("div",null,[Ml,r("div",zl,[r("div",Ll,[r("input",{value:"patchcdn.pathofexile.com/",readonly:"",class:w(e.$style.input)},null,2),r("label",{class:w(e.$style.label)},"Patch CDN",2)]),r("div",Il,[A(r("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>e.poePatch=s),placeholder:"3.12.x.x.x",class:w(e.$style.input)},null,2),[[de,e.poePatch,void 0,{trim:!0}]]),r("label",{class:w(e.$style.label)},"Patch #",2)]),r("div",Rl,[r("input",{value:"/Bundles2/_.index.bin",readonly:"",class:w(e.$style.input)},null,2),r("label",{class:w(e.$style.label)},"Index",2)]),r("button",{class:"ml-1 py-1 px-3 bg-blue-600 text-white hover:bg-blue-800",onClick:t[1]||(t[1]=(...s)=>e.cdnImport&&e.cdnImport(...s)),disabled:e.isCdnImportRunning,loading:e.isCdnImportRunning},$(e.isCdnImportRunning?"Wait...":"Import"),9,El)]),e.latestPoEPatch&&e.poePatch!==e.latestPoEPatch?(y(),v("div",Pl,[Dl,r("code",Hl,$(e.latestPoEPatch),1)])):_("",!0)])]),r("div",Fl,[r("div",{class:w(e.$style.importVariant)},"2",2),r("div",Bl,[Ol,Vl,r("input",{class:"hidden",id:"import-local-file",type:"file",accept:".dat,.dat64",onInput:t[2]||(t[2]=(...s)=>e.handleFile&&e.handleFile(...s))},null,32)])]),r("div",Al,[e.isFetchingSchema?(y(),v("i",Wl)):(y(),v("i",Nl)),r("div",null,[e.isFetchingSchema?(y(),v("span",jl," Downloading schema from ")):(y(),v("span",Yl," Downloaded schema from ")),Ul])])])}const it={};it.$style=kl;var rt=R(xl,[["render",Gl],["__cssModules",it]]);const se=S("poe-dat-viewer@import");function ee(e){se.value=e}const P=S([{id:"poe-dat-viewer@import",title:"Import",type:rt,args:void 0,kaScope:Ee(!0),kaState:void 0}]);function le(e){P.value.find(n=>n.id===e.id)||P.value.push({id:e.id,title:e.title,type:e.type,args:e.args,kaScope:Ee(!0),kaState:void 0}),ee(e.id),V(P)}function ql(e){const t=P.value.findIndex(n=>n.id===e);e===se.value&&(t+1<P.value.length?ee(P.value[t+1].id):ee(t!==0?P.value[t-1].id:null)),P.value[t].kaScope.stop(),P.value=P.value.filter(n=>n.id!==e)}function Xl(e){return P.value.some(t=>t.id===e)}const $e=S(!1),Se=S(0),Kl=S(0),ae=S(0),Jl=L({setup(){const e=M("dat-schemas");return{timeLeft:m(()=>{!ae.value&&e.tableStats.length&&(ae.value=Date.now()/1e3);const n=Date.now()/1e3,l=Se.value*(n-ae.value)/e.tableStats.length;return Math.max(Math.ceil(l-n+ae.value),0)}),totalTables:Se,isPreloading:$e,preloadDataTables:async()=>{ae.value=0,Kl.value=Date.now()/1e3,$e.value=!0,await e.preloadDataTables(Se),$e.value=!1},tables:m(()=>e.tableStats)}}}),Zl={class:"p-4 overflow-auto border-l flex-1 text-base"},Ql={key:1,class:"flex items-center gap-x-4"},ea=r("i",{class:"codicon codicon-loading animate-spin"},null,-1),ta={key:0},na={class:"border mt-4"},sa=r("thead",null,[r("tr",null,[r("th",{class:"border-b px-4"},"Name"),r("th",{class:"border-b px-4"},"Rows"),r("th",{class:"border-b px-8"},"Valid"),r("th",{class:"border-b px-4"},"More data")])],-1),la={class:"border-b px-4"},aa={class:"border-b px-4 text-right"},oa={key:0},ia=r("td",{colspan:"2",class:"px-8 py-4"},"Waiting for preload...",-1),ra=[ia];function da(e,t,n,l,a,o){return y(),v("div",Zl,[!e.isPreloading&&!e.tables.length?(y(),v("button",{key:0,class:"py-1 px-3 bg-blue-600 text-white hover:bg-blue-800",onClick:t[0]||(t[0]=(...s)=>e.preloadDataTables&&e.preloadDataTables(...s))},"Preload Data tables")):e.tables.length!==e.totalTables?(y(),v("div",Ql,[ea,r("div",null,[z($(e.tables.length)+" / "+$(e.totalTables)+" tables",1),e.tables.length?(y(),v("span",ta,", estimated "+$(e.timeLeft)+" sec",1)):_("",!0)])])):_("",!0),r("table",na,[sa,r("tbody",null,[(y(!0),v(k,null,I(e.tables,s=>(y(),v("tr",{key:s.name},[r("td",la,$(s.name),1),r("td",aa,$(s.totalRows),1),r("td",{class:w(["border-b px-4 text-center",{"bg-red-400":!s.headersValid}])},$(s.headersValid),3),r("td",{class:w(["border-b px-4 text-center",{"bg-yellow-300":s.increasedRowLength}])},$(s.increasedRowLength),3)]))),128)),e.tables.length?_("",!0):(y(),v("tr",oa,ra))])])])}var ca=R(Jl,[["render",da]]);const ua="_titlebar_v2ooq_2",fa="_tab_v2ooq_12",ha="_active_v2ooq_21",pa="_rightBtn_v2ooq_31";var ya={titlebar:ua,tab:fa,active:ha,rightBtn:pa};const va=L({setup(){const e=M("bundle-index"),t=M("dat-schemas"),n=m(()=>P.value.map(o=>({id:o.id,title:o.title,isActive:o.id===se.value})));function l(){le({id:"poe-dat-viewer@import",title:"Import",type:rt,args:void 0})}function a(){le({id:"poe-dat-viewer@data-tables",title:"Data Tables",type:ca,args:void 0})}return{tabs:n,setActiveTab:ee,closeTab:ql,openImport:l,openDataTables:a,showDataTables:m(()=>e.isLoaded&&t.isLoaded)}}}),ma={class:"flex overflow-hidden divide-x divide-gray-600"},ga=["onClick","onMouseup"],ba=["onClick"],wa=r("i",{class:"codicon codicon-close"},null,-1),_a=[wa],$a={class:"flex p-1.5 flex-shrink-0 gap-x-1"},Sa=r("i",{class:"codicon codicon-cloud-download"},null,-1),ka=z(" Import"),xa=[Sa,ka],Ca=r("i",{class:"codicon codicon-table"},null,-1),Ta=z(" Data Tables"),Ma=[Ca,Ta];function za(e,t,n,l,a,o){return y(),v("div",{class:w(e.$style.titlebar)},[r("div",ma,[(y(!0),v(k,null,I(e.tabs,s=>(y(),v("div",{key:s.id,class:w([e.$style.tab,{[e.$style.active]:s.isActive}])},[r("button",{class:"pl-3 h-full",onClick:i=>e.setActiveTab(s.id),onMouseup:zt(i=>e.closeTab(s.id),["middle"])},$(s.title),41,ga),r("button",{class:"mx-2 w-7 h-7 hover:bg-gray-500 text-center",title:"Close",onClick:i=>e.closeTab(s.id)},_a,8,ba)],2))),128))]),r("div",$a,[r("button",{class:w(e.$style.rightBtn),onClick:t[0]||(t[0]=(...s)=>e.openImport&&e.openImport(...s))},xa,2),e.showDataTables?(y(),v("button",{key:0,class:w(e.$style.rightBtn),onClick:t[1]||(t[1]=(...s)=>e.openDataTables&&e.openDataTables(...s))},Ma,2)):_("",!0)])],2)}const dt={};dt.$style=ya;var La=R(va,[["render",za],["__cssModules",dt]]);const Ia=()=>L({components:{ResizeObserver:Pe,CanvasScroll:Ve},props:{items:{type:Array,required:!0},itemHeight:{type:Number,required:!0},scrollableProps:{type:Object,default:()=>({})}},setup(e){const t=re({width:0,height:0}),n=m(()=>({width:t.width,height:e.items.length*e.itemHeight}));function l(s){t.width=s.width,t.height=s.height}const a=J(null),o=m(()=>{var f,d;const s=(d=(f=a.value)==null?void 0:f.scrollPos.y)!=null?d:0,i=Math.ceil(t.height/e.itemHeight)+1,c=Math.floor(s/e.itemHeight),u=c*e.itemHeight-s;return e.items.slice(c,c+i).map((h,g)=>({top:u+g*e.itemHeight,item:h}))});return{handleResize:l,paintSize:t,fullSize:n,scrollable:a,renderItems:o}}}),Ra=Ia();function Ea(e,t,n,l,a,o){const s=H("canvas-scroll"),i=H("resize-observer");return y(),ge(i,{onResize:e.handleResize,class:"relative"},{default:Z(()=>[F(s,Lt({ref:"scrollable"},e.scrollableProps,{class:"absolute","paint-size":e.paintSize,"full-size":e.fullSize}),{default:Z(()=>[be(e.$slots,"default",{entries:e.renderItems})]),_:3},16,["paint-size","full-size"])]),_:3},8,["onResize"])}var Pa=R(Ra,[["render",Ea]]);const Da="_treeToggle_2880p_2",Ha="_searchInput_2880p_12",Fa="_itemBtn_2880p_25",Ba="_active_2880p_39";var Oa={treeToggle:Da,searchInput:Ha,itemBtn:Fa,active:Ba};function Va(e){const t=S("");e.watch(()=>{t.value=""});const n=m(()=>e.getDirContent(t.value)),l=m(()=>e.isLoaded?t.value===""?e.getRootDirs().map(s=>({label:s,fullPath:s,isFile:!1})).sort((s,i)=>s.label.localeCompare(i.label)):[{label:"../",fullPath:t.value.indexOf("/")===-1?"":t.value.split("/").slice(0,-1).join("/"),isFile:!1},...n.value.dirs.map(o=>({label:o.substr(t.value.length+1),fullPath:o,isFile:!1})).sort((o,s)=>o.label.localeCompare(s.label)),...n.value.files.map(o=>({label:o.substr(t.value.length+1),fullPath:o,isFile:!0,isActive:`bundles@${o}`===se.value})).sort((o,s)=>o.label.localeCompare(s.label))]:[]);async function a(o){if(!o.isFile)t.value=o.fullPath;else{if((o.fullPath.endsWith(".dat")||o.fullPath.endsWith(".dat64"))&&Xl(`bundles@${o.fullPath}`)){ee(`bundles@${o.fullPath}`);return}const s=await e.loadFileContent(o.fullPath);o.fullPath.endsWith(".dat")||o.fullPath.endsWith(".dat64")?le({id:`bundles@${o.fullPath}`,title:o.label,type:ot,args:{fileContent:s,fullPath:o.fullPath}}):Me.saveAs(new File([s],o.fullPath.substring(o.fullPath.lastIndexOf("/")+1),{type:"application/octet-stream"}))}}return{currentDir:t,tree:l,handleTreeNav:a}}const Aa=L({components:{VirtualScroll:Pa},setup(){const e=M("bundle-index"),t=S(!0);function n(){t.value=!t.value}const{tree:l,handleTreeNav:a,currentDir:o}=Va(e),s=S(".dat64"),i=m(()=>o.value.startsWith("Data")?[".dat",".dat64",".datl",".datl64"].map(f=>({value:f,active:s.value===f,handleClick:()=>{s.value=f}})):null),c=S(""),u=m(()=>{const f=c.value.toLowerCase(),d=i.value?s.value:"";return l.value.filter(h=>h.label.toLowerCase().includes(f)&&(h.isFile?h.label.endsWith(d):!0))});return{showTree:t,toggleTree:n,tree:u,handleTreeNav:a,searchText:c,isIndexLoaded:m(()=>e.isLoaded),extensionOpts:i}}}),Wa={class:"flex p-1 items-center mb-px"},Na=r("i",{class:"codicon codicon-list-flat"},null,-1),ja=[Na],Ya={key:0,class:"flex gap-x-1 border-b pb-1.5 px-2 justify-end"},Ua=["onClick","textContent"],Ga={key:1,class:"italic text-center text-gray-500 p-2"},qa={key:2,class:"italic text-center text-gray-500 p-2"},Xa=["onClick"],Ka={key:0,class:"codicon codicon-folder pr-3"};function Ja(e,t,n,l,a,o){const s=H("virtual-scroll");return y(),v("div",{class:"layout-column flex-shrink-0",style:C({width:e.showTree?"300px":void 0})},[r("div",Wa,[r("button",{title:"Toggle tree visibility",class:w(e.$style.treeToggle),onClick:t[0]||(t[0]=(...i)=>e.toggleTree&&e.toggleTree(...i))},ja,2),e.showTree?A((y(),v("input",{key:0,"onUpdate:modelValue":t[1]||(t[1]=i=>e.searchText=i),placeholder:"Search in current folder",class:w(e.$style.searchInput),type:"search",spellcheck:"false"},null,2)),[[de,e.searchText,void 0,{trim:!0}]]):_("",!0)]),e.showTree?(y(),v(k,{key:0},[e.extensionOpts?(y(),v("div",Ya,[(y(!0),v(k,null,I(e.extensionOpts,i=>(y(),v("button",{key:i.value,onClick:i.handleClick,class:w(["px-2",i.active?"bg-gray-200":"hover:bg-gray-100"]),textContent:$(i.value)},null,10,Ua))),128))])):_("",!0),e.isIndexLoaded?_("",!0):(y(),v("div",Ga,"Waiting for Index bundle...")),e.isIndexLoaded&&!e.tree.length?(y(),v("div",qa,"No results found")):_("",!0),F(s,{class:"flex-1","scrollable-props":{style:"background: #fff;",widthY:10},items:e.tree,"item-height":22},{default:Z(i=>[(y(!0),v(k,null,I(i.entries,c=>(y(),v("button",{key:c.item.fullPath,class:w({[e.$style.itemBtn]:!0,[e.$style.active]:c.item.isActive}),style:C({transform:`translate(0, ${c.top}px`}),onClick:u=>e.handleTreeNav(c.item)},[c.item.isFile?_("",!0):(y(),v("i",Ka)),z($(c.item.label),1)],14,Xa))),128))]),_:1},8,["items"])],64)):_("",!0)],4)}const ct={};ct.$style=Oa;var Za=R(Aa,[["render",Ja],["__cssModules",ct]]);const Qa="_notification_eng9d_2";var eo={notification:Qa};const to=L({setup(){return{progress:M("bundle-loader").progress}}}),no=r("div",{class:"bg-gray-200 h-1"},null,-1),so={class:"p-3"},lo={class:"font-semibold truncate"},ao={class:"text-grey text-sm"},oo=z("Downloading...");function io(e,t,n,l,a,o){return e.progress?(y(),v("div",{key:0,class:w(e.$style.notification)},[e.progress.totalSize?(y(),v(k,{key:0},[no,r("div",{class:"bg-blue-500 h-1 absolute top-0",style:C({width:`${e.progress.received/e.progress.totalSize*100}%`})},null,4)],64)):_("",!0),r("div",so,[r("div",lo,$(e.progress.bundleName),1),r("div",ao,[e.progress.totalSize?(y(),v(k,{key:0},[z($((e.progress.totalSize/1e6).toFixed(1))+" MB",1)],64)):(y(),v(k,{key:1},[oo],64))])])],2)):_("",!0)}const ut={};ut.$style=eo;var ro=R(to,[["render",io],["__cssModules",ut]]);const co="Bundles2";class uo{constructor(){D(this,"patchVer","");D(this,"state",re({totalSize:0,received:0,bundleName:"",isDownloading:!1,active:null}));D(this,"registry",new FinalizationRegistry(t=>{console.debug(`[Bundle] garbage-collected, name: "${t}"`)}));D(this,"weakCache",new It(20*1e3));D(this,"progress",m(()=>this.state.isDownloading?{totalSize:this.state.totalSize,received:this.state.received,bundleName:this.state.bundleName}:null))}async setPatch(t){this.state.active&&await this.state.active,this.patchVer&&this.patchVer!==t&&(this.weakCache.clear(),await window.caches.delete("bundles")),this.patchVer=t}async fetchFile(t){let n=this.weakCache.get(t);if(n&&n.byteLength!==0)return console.log(`[Bundle] name: "${t}", source: memory.`),this.weakCache.set(t,n),n;const{state:l}=this;if(l.active)return await l.active,await this.fetchFile(t);const a=this._fetchFile(t);l.active=a;try{return n=await a,this.registry.register(n,t),this.weakCache.set(t,n),n}catch(o){throw window.alert("You may need to adjust the patch version."),o}finally{l.active=null}}async _fetchFile(t){const{state:n,patchVer:l}=this,a=`${l}/${co}/${t}`,o=await window.caches.open("bundles");let s=await o.match(a);if(s)console.log(`[Bundle] name: "${t}", source: disk cache.`);else{if(console.log(`[Bundle] name: "${t}", source: network.`),n.totalSize=0,n.received=0,n.isDownloading=!0,n.bundleName=t,s=await fetch(`https://poe-bundles.snos.workers.dev/${a}`),s.status!==200)throw n.isDownloading=!1,new Error(`patchcdn: ${s.status} ${s.statusText}`);n.totalSize=Number(s.headers.get("content-length"));let i;try{const c=s.body.getReader(),u=[];for(;;){const{done:d,value:h}=await c.read();if(d)break;u.push(h),n.received+=h.length}i=new Uint8Array(n.received);let f=0;for(const d of u)i.set(d,f),f+=d.length}finally{n.isDownloading=!1}return await o.put(a,new Response(i,{headers:{"content-length":String(i.byteLength),"content-type":"application/octet-stream"}})),i.buffer}return await s.arrayBuffer()}}function fo(){return Date.now()}function ho(e,t){const n=Date.now()-t;console.log(`${e}. Done in -> ${n} ms`)}function ft(e,t){const n=fo(),l=t();return ho(e,n),l}class po{constructor(t){D(this,"index",S(null));this.loader=t}get isLoaded(){return this.index.value!=null}async loadIndex(){const t=await this.loader.fetchFile("_.index.bin"),{slice:n}=await Ge(t),l=ue.readIndexBundle(n),{slice:a}=await Ge(l.pathRepsBundle.slice().buffer);this.index.value={bundlesInfo:l.bundlesInfo,filesInfo:l.filesInfo,dirsInfo:l.dirsInfo,pathReps:a}}async loadFileContent(t){const{bundlesInfo:n,filesInfo:l}=this.index.value,a=ue.getFileInfo(t,n,l),o=await this.loader.fetchFile(a.bundle),{slice:s}=await qe(o.slice(0),a.offset,a.size);return s}getDirContent(t){const{pathReps:n,dirsInfo:l}=this.index.value;return ft(`[Index] getting "${t}" dir`,()=>ue.getDirContent(t,n,l))}getRootDirs(){const{pathReps:t,dirsInfo:n}=this.index.value;return ft("[Index] getting root dirs",()=>ue.getRootDirs(t,n))}async getBatchFileInfo(t){const{bundlesInfo:n,filesInfo:l}=this.index.value;return await en(t,n,l)}watch(t){U(this.index,t)}}class yo{constructor(t){D(this,"publicSchema",S([]));D(this,"_isLoading",S(!1));D(this,"_tableStats",S([]));D(this,"db",Rt("poe-dat-viewer",3,{upgrade(t){t.createObjectStore("dat-schemas",{keyPath:"name"})}}));this.index=t}get isLoaded(){return this.publicSchema.value.length>0}get isLoading(){return this._isLoading.value}get tableStats(){return this._tableStats.value}async fetchSchema(){this._isLoading.value=!0;const n=await(await fetch("https://poe-bundles.snos.workers.dev/schema.min.json")).json();n.version===Et.SCHEMA_VERSION?this.publicSchema.value=n.tables:console.warn("Latest schema version is not supported."),this._isLoading.value=!1}async findByName(t){const n=await(await this.db).get("dat-schemas",t);return(n==null?void 0:n.headers)||mo(t,this.publicSchema.value)||[]}async saveHeaders(t,n){await(await this.db).put("dat-schemas",{name:t,headers:vo(n)})}async removeHeaders(t){await(await this.db).delete("dat-schemas",t)}async preloadDataTables(t){const n=this.index.getDirContent("Data").files.filter(o=>o.endsWith(".dat64"));t.value=n.length;const a=(await this.index.getBatchFileInfo(n)).reduce((o,s,i)=>{const c=o.find(f=>f.name===s.bundle),u=n[i];return c?c.files.push({fullPath:u,location:s}):o.push({name:s.bundle,files:[{fullPath:n[i],location:s}]}),o},[]);for(const o of a){let s=await this.index.loader.fetchFile(o.name);for(const{fullPath:i,location:c}of o.files){const u=await qe(s,c.offset,c.size);s=u.bundle;const f=G.readDatFile(i,u.slice),d=await _e(f,{transfer:!0}),h=i.replace("Data/","").replace(".dat64",""),g=await this.findByName(h),p=Ue(g,d,f);this._tableStats.value.push({name:h,totalRows:f.rowCount,headersValid:p!=null,increasedRowLength:p?p.increasedRowLength:!1}),V(this._tableStats)}}}}function vo(e){return e.map(t=>ie(oe({},t),{length:t.type.string||t.type.array||t.type.key||t.type.boolean||t.type.decimal||t.type.integer?void 0:t.length}))}function mo(e,t){const n=t.find(l=>l.name===e);return n?n.columns.map(l=>{var a,o;return{name:l.name||"",type:{array:l.array,byteView:l.type==="array"?{array:!0}:void 0,integer:l.type==="i32"?{unsigned:!1,size:4}:l.type==="enumrow"?{unsigned:!1,size:4}:void 0,decimal:l.type==="f32"?{size:4}:void 0,string:l.type==="string"?{}:void 0,boolean:l.type==="bool"?{}:void 0,key:l.type==="row"||l.type==="foreignrow"?{foreign:l.type==="foreignrow",table:(o=(a=l.references)==null?void 0:a.table)!=null?o:null,viewColumn:null}:void 0},textLength:4*3-1}}):null}var go="/poe-dat-viewer/assets/discord-badge.9068e0df.svg";const bo=L({components:{IndexTree:Za,ViewerTabs:La,DownloadProgress:ro},setup(){const e=new uo,t=new po(e),n=new yo(t);return ce("bundle-loader",e),ce("bundle-index",t),ce("dat-schemas",n),{activeTab:m(()=>P.value.find(a=>a.id===se.value)),appVersion:"3.3.0"}}}),wo={class:"layout-column flex-1 min-w-0"},_o={class:"layout-column flex-1 min-h-0"},$o={key:1,class:"bg-gray-50 flex-1 text-lg text-gray-500 flex items-center justify-center"},So={class:"app-footer"},ko=r("a",{class:"q-link text-white border-b",href:"https://github.com/SnosMe/poe-dat-viewer"},"GitHub",-1),xo=r("a",{href:"https://discord.gg/SJjBdT3",class:"flex ml-8"},[r("img",{src:go})],-1);function Co(e,t,n,l,a,o){const s=H("index-tree"),i=H("viewer-tabs"),c=H("download-progress");return y(),v(k,null,[F(s),r("div",wo,[F(i),r("div",_o,[e.activeTab?(y(),ge(Te(e.activeTab.type),{args:e.activeTab.args,key:e.activeTab.id,"ka-scope":e.activeTab.kaScope,"ka-state":e.activeTab.kaState,"onUpdate:ka-state":t[0]||(t[0]=u=>e.activeTab.kaState=u)},null,8,["args","ka-scope","ka-state"])):(y(),v("div",$o,"The viewer is ready to fulfill your wishes \u{1F47E}"))]),r("div",So,[r("div",null,[z("Made by Alexander Drozdov, v"+$(e.appVersion)+" ",1),ko]),xo])]),F(c)],64)}var To=R(bo,[["render",Co]]);Pt(To).mount("#app");
